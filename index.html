<!DOCTYPE html>
<meta charset="UTF-8">
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <link href=" https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC " crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM " crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        $(document).ready(function () {
            const api = "https://api.trello.com/1"
            var globalToken = ""
            var globalKey = ""
            updatePayload()
            function auth() {
                return '?key=' + globalKey + '&token=' + globalToken
            }
            function getUrl(url) {
                return api + url + auth()
            }
            function testAuth() {
                console.log('testing auth with key: ' + window.Trello.key())
                console.log('testing auth with token: ' + window.Trello.token())
                console.log('testing auth with key: ' + globalKey)
                console.log('testing auth with token: ' + globalToken)
                $.ajax({
                    type: 'get',
                    url: getUrl('/members/me'),
                    success: (result) => {
                        $('#unauthorized-section').hide()
                        $('#authorized-section').show()
                    },
                    error: (result) => {
                        $('#unauthorized-section').show()
                        $('#authorized-section').hide()
                    }
                })
            }
            function loadClientLibrary(key,tok) {
                $.getScript('https://api.trello.com/1/client.js')
                    .done(() => {
                        globalKey = key
                        globalToken = tok
                        testAuth()
                    })
                    .fail(() => {
                        console.log('oops')
                    })
            }
            function loadPersonalAuth() {
                loadClientLibrary($('#apiKey').val(), $('#apitoken').val())
            }
            function loadAppAuth() {
                var authenticationSuccess = function () {
                    console.log('Successful authentication')
                    globalKey = window.Trello.key()
                    globalToken = window.Trello.token()
                    testAuth()
                }
                var authenticationFailure = function () {
                    console.log('Failed authentication')
                    testAuth()
                }
                $.getScript('https://api.trello.com/1/client.js?key=96f43e70a38cbb59313af81e232df069')
                    .done(() => {
                        window.Trello.authorize({
                            type: 'popup',
                            name: 'Trello Webhook Manager',
                            scope: {
                                read: 'true',
                                write: 'true'
                            },
                            return_url: 'https://trellowebhooks.devtechfm.com',
                            expiration: 'never',
                            success: authenticationSuccess,
                            error: authenticationFailure
                        })
                    })
                    .fail(() => {
                        console.log('oops')
                    })
            }
            $('#btn-load-auth').click(() => {
                if (isPersonalAuthMethod()) {
                    loadPersonalAuth()
                } else {
                    loadAppAuth()
                }
            })
            $('#btn-get-webhooks').click(() => {
                var url = api + '/tokens/' + globalToken + '/webhooks?key=' + globalKey + '&token=' + globalToken
                console.log('webhooks url: ' + url)
                $.ajax({
                    type: 'get',
                    url: url,
                    dataType: 'json',
                    contentType: 'application/json',
                    success: (data) => {
                        var webhooks = data
                        for (var i = 0; i < webhooks.length; i++) {
                            var hook = webhooks[i]
                            var html = '<div class="card bg-dark webhook-payload-container">'
                                + '<div class="card-body">'
                                + '<pre class="text-white">'
                                + JSON.stringify(hook, null, 4)
                                + '</pre>'
                                + '</div>'
                                + '</div>'
                            $('#existing-webhooks-container').append(html)
                        }
                    },
                    error: (result) => {
                        console.log('error')
                    }
                })
            })
            $('#webhook-description').on('input', () => {
                updatePayload()
            })
            $('#webhook-callbackURL').on('input', () => {
                updatePayload()
            })
            $('#webhook-model-id').on('input', () => {
                updatePayload()
            })
            $('#submit').click(() => {
                paramObj = {
                    token: globalToken,
                    description: $('#webhook-description').val(),
                    callbackURL: $('#webhook-callbackURL').val(),
                    idModel: $('#webhook-model-id').val()
                }
                var url = getUrl('/webhooks')
                console.log(url)
                console.log(JSON.stringify(paramObj))
                $.ajax({
                    type: 'post',
                    url: url,
                    dataType: 'json',
                    data: JSON.stringify(paramObj),
                    contentType: 'application/json',
                    success: (result) => {
                        console.log('success')
                    },
                    error: (result) => {
                        console.log(result)
                        console.log('error')
                    }
                })
            })

            $('#btn-find-model').click(() => {
                loadBoardsIntoFindModal()
            })

            $('#btn-test-callbackurl').click((e) => {
                const el = $('#btn-test-callbackurl')
                el.removeClass('btn-secondary')
                $('#test-callbackurl-icon').text('refresh')
                $('#test-callbackurl-icon').addClass('spin-element')
                $.ajax({
                    type: 'head',
                    url: $('#webhook-callbackURL').val(),
                    crossDomain: true,
                    complete: () => {
                        $('#test-callbackurl-icon').removeClass('spin-element')
                    },
                    success: (result) => {
                        console.log('success')
                        el.addClass('btn-success')
                        el.removeClass('btn-danger')
                        $('#test-callbackurl-icon').text('check')
                    },
                    error: (result) => {
                        console.log('error')
                        el.addClass('btn-danger')
                        $('#test-callbackurl-icon').text('error')
                    }
                })
            })

            // respond to board selection
            $(document).on('click', '#ddl-boards li a', (e) => {
                const el = $(e.target)
                const boardId = el.attr('trello-id')
                $('#ddl-boards-button').text(el.text())
                updateWebhookModelId(boardId)
                loadListsIntoFindModal(boardId)
                updateModelNamingConvention()
            })

            // respond to list selection
            $(document).on('click', '#ddl-lists li a', (e) => {
                const el = $(e.target)
                const listId = el.attr('trello-id')
                $('#ddl-lists-button').text(el.text())
                updateWebhookModelId(listId)
                loadCardsIntoFindModal(listId)
                updateModelNamingConvention()
            })

            // respond to card selection
            $(document).on('click', '#ddl-cards li a', (e) => {
                const el = $(e.target)
                const cardId = el.attr('trello-id')
                $('#ddl-cards-button').text(el.text())
                updateWebhookModelId(cardId)
                updateModelNamingConvention()
            })

            function loadThing(url,ddl) {
                $.ajax({
                    type: 'get',
                    url: url,
                    dataType: 'json',
                    contentType: 'application/json',
                    success: (things) => {
                        $('#find-model-modal').modal('show')
                        $(ddl).empty()
                        for (var i = 0; i < things.length; i++) {
                            var thing = things[i]
                            $(ddl).append('<li><a class="dropdown-item" href="#" trello-id="' + thing.id + '">' + thing.name + '</a></li>')
                        }
                    },
                    error: (result) => {
                        console.log('error')
                    }
                })
            }
            function loadBoardsIntoFindModal() {
                loadThing(getUrl('/members/me/boards') + '&fields=name&filter=open', '#ddl-boards')
            }
            function loadListsIntoFindModal(boardId) {
                loadThing(getUrl('/boards/' + boardId + '/lists') + '&fields=name', '#ddl-lists')
                $('#ddl-lists-button').text('Select a List')
            }
            function loadCardsIntoFindModal(listId) {
                loadThing(getUrl('/lists/' + listId + '/cards') + '&fields=name', '#ddl-cards')
                $('#ddl-cards-button').text('Select a Card')
            }
            function updateWebhookModelId(modelId) {
                $('#webhook-model-id').val(modelId)
            }
            function prepForModalName(txt) {
                if (txt.toLowerCase().startsWith('select a')) {
                    return ""
                }
                return txt.toLowerCase().replace(/[&\/\\#,+()$~%.'":*!?<>{}]/g, '').replace(/\s/g, '-').replace(/-+/g, '-')
            }
            function prepBoardForModalName(boardName) {
                const n = prepForModalName(boardName)
                if (n) {
                    return n
                }
                return ""
            }
            function prepListForModalName(listName) {
                const l = prepForModalName(listName)
                if (l) {
                    return ":" + l
                }
                return ""
            }
            function prepCardForModalName(cardName) {
                const c = prepForModalName(cardName)
                if (c) {
                    return ":" + c
                }
                return ""
            }
            function updateModelNamingConvention() {
                const board = prepBoardForModalName($('#ddl-boards-button').text())
                const list = prepListForModalName($('#ddl-lists-button').text())
                const card = prepCardForModalName($('#ddl-cards-button').text())
                newText = board + list + card
                $('#webhook-description').val(newText)
                updatePayload()
            }
            function updatePayload() {
                var desc = $('#webhook-description').val()
                var callUrl = $('#webhook-callbackURL').val()
                var modelId = $('#webhook-model-id').val()
                var finalObj = {
                    description: (desc != "" ? desc : ""),
                    callbackURL: (callUrl != "" ? callUrl : ""),
                    idModel: (modelId != "" ? modelId : "")
                }
                $('#webhook-payload').text(JSON.stringify(finalObj, null, 4))
            }
            function isPersonalAuthMethod() {
                const auth = $('#auth-method-option')
                const isPersonal = auth.prop('checked')
                return isPersonal
            }
            function deauth() {
                if (window.Trello) {
                    window.Trello.deauthorize()
                }
                globalKey = globalToken = ""
                $('#unauthorized-section').hide()
                $('#authorized-section').hide()
                $('#existing-webhooks-container').empty()
            }
            $('#btn-deauth').click(() => {
                deauth()
            })
            $('#auth-method-option').click(() => {
                deauth()
                const deauthBtn = $('#btn-deauth')
                const apiField = $('#apiKey')
                const tokField = $('#apitoken')
                const authFields = $('.auth-fields')
                if (isPersonalAuthMethod()) {
                    apiField.val('')
                    tokField.val('')
                    authFields.show()
                    deauthBtn.hide()
                } else {
                    apiField.val('')
                    tokField.val('')
                    deauthBtn.show()
                    authFields.hide()
                }
            })
        })
    </script>
    <style>
        .row {
            margin-bottom: 20px;
        }

        pre {
            margin-bottom: 0;
        }

        .webhook-payload-container {
            margin-bottom: 10px;
        }
        
        #submit {
            margin-top: 5px;
        }

        .material-icons {
            vertical-align: middle;
            line-height: 0 !important;
            position: relative;
            top: -1px;
        }

        #authorized-section,
        #unauthorized-section,
        #btn-deauth {
            display: none;
        }

        .spin-element {
            animation-name: spin;
            animation-duration: 5000ms;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body id="body" class="container">
    <div class="row">
        <div class="col">
            <h1>Trello Webhook Manager</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-2">
            <h3>Authorization</h3>
        </div>
        <div class="col">
            <div class="form-check form-switch" style="padding-top: 8px">
                <input class="form-check-input" type="checkbox" id="auth-method-option" checked>
                <label class="form-check-label" id="lbl-auth-method-option" for="auth-method-option">Personal Authorization</label>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-3 auth-fields">
            <input type="password" class="form-control" id="apiKey" placeholder="API Key" name="apikey" value="">
        </div>
        <div class="col-3 auth-fields">
            <input type="password" class="form-control" id="apitoken" placeholder="API Token" name="apitoken" value="">
        </div>
        <div class="col-3">
            <button type="button" class="btn btn-primary" id="btn-load-auth">Authorize</button>
            <button type="button" class="btn btn-danger" id="btn-deauth">Deauthorize</button>
        </div>
        
    </div>
    <div id="authorized-section">
        <div class="row">
            <div class="col">
                <h3>Register a New Webhook</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 col-lg-5 bottomspace-medium">
                <div class="card">
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label for="description">Description:</label>
                                <input type="text" id="webhook-description" class="form-control w-100" name="description" autocomplete="off" />
                            </div>

                            <div class="mb-3">
                                <label for="callbackURL">Callback URL:</label>
                                <div class="input-group mb-3">
                                    <input type="text" id="webhook-callbackURL" class="form-control" name="callbackURL" autocomplete="off" />
                                    <button class="btn btn-secondary" type="button" id="btn-test-callbackurl"><span id="test-callbackurl-icon" class="material-icons">public</span></button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="idModel">ID of the Model:</label>
                                <div class="input-group mb-3">
                                    <input id="webhook-model-id" type="text" class="form-control">
                                    <button class="btn btn-secondary" type="button" id="btn-find-model"><span class="material-icons">search</span></button>
                                </div>
                            </div>

                            <button type="button" id="submit" class="btn btn-primary"><span class="spinner"></span>Submit</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-12 col-lg-7">
                <div class="card bg-dark">
                    <div class="card-body">
                        <pre id="webhook-payload" class="text-white"></pre>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <h3>Your Webhooks</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-4">
                <button type="button" id="btn-get-webhooks" class="btn btn-secondary">Get Webhooks</button>
            </div>
        </div>
        <div class="row">
            <div id="existing-webhooks-container" class="col"></div>
        </div>
    </div>
    <div id="unauthorized-section">
        <div class="row">
            <div class="col">
                <p class="text-danger">Invalid API Key or Token.</p>
            </div>
        </div>
    </div>
    <div id="find-model-modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Model Browser</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col">
                            <h5>Boards</h5>
                            <div class="dropdown">
                                <button id="ddl-boards-button" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Select a Board</button>
                                <ul id="ddl-boards" class="dropdown-menu" aria-labelledby="ddl-boards-button"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h5>Lists</h5>
                            <div class="dropdown">
                                <button id="ddl-lists-button" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Select a List</button>
                                <ul id="ddl-lists" class="dropdown-menu" aria-labelledby="ddl-lists-button"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h5>Cards</h5>
                            <div class="dropdown">
                                <button id="ddl-cards-button" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Select a Card</button>
                                <ul id="ddl-cards" class="dropdown-menu" aria-labelledby="ddl-cards-button"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <pre id="find-model-output"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
